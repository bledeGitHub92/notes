## find 简介

find 查询就是返回一个集合中文档的子集，子集的范围从0个文档到整个集合

    db.find([ cond ])

findOne 返回匹配的第一个文档

    db.findOne([ cond ])

### 指定需要返回的键

有时并不需要将文档中的所有键 / 值返回。可以指定 find / findOnde 的第二个参数来过滤

- 结果文档包含指定键

  > 结果文档仅包含 filed1 、field2、\_id，\_id键默认总被返回

        db.find([ cond ], {
            [ field1 ]: 1,
            [ field2 ]: 1
        })

- 结果文档剔除指定键

  > 结果文档不包含 filed1 、field2、\_id，使用这种方式可以剔除 \_id 键

        db.find([ cond ], {
            [ field1 ]: 0,
            [ field2 ]: 0,
            _id: 0
        })

### 限制

传递给数据库的查询文档必须是常量

    <!-- 这样是行不通的  -->
    db.stock.find({ in_stock: 'this.num_sold' })

## 查询条件

查询能匹配复杂条件，比如范围、OR子句、取反

### 查询条件

比较操作符

| 操作符 | 作用  | 操作符  | 作用   |
|-----|-----|------|------|
| $lt | 小于  | $lte | 小于等于 |
| $gt | 大于  | $gte | 大于等于 |
| $ne | 不等于 |      |      |

    <!-- age 字段大于18小于30  -->
    db.users.find({ age:
        { $gte: 18, $lte: 30 }
    })

### $in & $or 查询

$in 一个键匹配多个值

> $in 的参数数组可以指定不同类型的值

    <!-- 返回字段 ticket_no 匹配725, 545, 390的文档  -->
    db.raffle.find({ ticket_no: { $in: [ 725, 545, 390 ] }})

$nin 和 $in 相反，返回指定字段不在参数数组中的文档

    <!-- 返回字段 ticket_no 不匹配725, 545, 390的文档  -->
    db.raffle.find({ ticket_no: { $nin: [ 725, 545, 390 ] }})

$or 多个键匹配对应值

    <!-- 返回字段 ticket_no 为725或 winner 为 true 的文档  -->
    db.raffle.find({
        $or: [
            { ticket_no: 725 }, 
            { winner: true }
        ]
    })

$or 与 $in 组合使用

    db.raffle.find({
        $or: [
            { ticket_no: { $in: [725, 545, 390] } },
            { winner: true }
        ]
    })

### $not 查询

$not 是原条件语义，可用在任何其他条件之上

> 取模运算符 $mod 会将指定字段值除以第一个参数值，若余数等于第二个参数则匹配成功

    <!-- 返回 id_num 值为1、6、11、16、..文档  -->
    db.users.find({ id_num: { $mod: [5, 1] } })

    <!-- 返回 id_num 值为2、3、4、5、..文档  -->
    db.users.find({ id_num: { { $not: { $mod: [5, 1] } } })


### 条件语义

- 条件语句是内层文档的键，修改器是外层文档的键

  > 一些元操作符也位于最外层文档中，$and、$or、$nor

        <!-- 匹配包含 { x: [0, 4] } 的文档 -->
        db.users.find({
            $and: [
                { x: { $lt: 1 } },
                { x: 4 }
            ]
        })

        <!-- 查询优化器不会对 $and 进行优化  -->
        <!-- 效率更高  -->
        db.users.find({ x: { $lt: 1, $in: [4] } })

- 一个键可以有任意多个条件，但不能对应多个修改器

## 特定类型查询

null 能匹配自身，且匹配不包含指定字段的文档

    > db.c.find()
    { y: null }
    { y: 1 }
    { y: 2 }

    > db.c.find({ y: null })
    { y: null }

    > db.c.find({ z: null })
    { y: null }
    { y: 1 }
    { y: 2 }

匹配值为 null 的文档，既要检查值是否为 null，还要通过 $exists 条件判定键值存在

    db.c.find(z: { $in: [ null ], $exists: true })

### 正则表达式

更加灵活的匹配字符串

    <!-- 忽略大小写  -->
    db.users.find({ name: /joe/i })

正则表达式也可以匹配自身

    > db.foo.insert({ bar: /baz/ })
    > db.foo.find({bar: /baz/})
    {
        _id: ...
        bar: /baz/
    }

### 查询数组

#### 查询数组和查询标量是一样的

    > db.food.insert({
        fruit: ['banana', 'apple', 'peach']
    })

    <!-- 能匹配上面添加的文档  -->
    db.food.find({ fruit: 'banana' })

#### $all 通过多个元素来匹配数组

> 带匹配数组顺序无关紧要

    > db.food.insertMany([
        { fruit: ['apple', 'banana', 'peach'] },
        { fruit: ['apple', 'kumquat', 'orange'] },
        { fruit: ['cherry', 'banana', 'apple'] },
    ])

    > db.food.find({ fruit: { $all: ['apple', 'banana'] } })
    { _id: ..., fruit: ['apple', 'banana', 'peach'] }
    { _id: ..., fruit: ['cherry', 'banana', 'apple'] }

查询数组特定位置的元素，key.index

    db.food.find({ fruit.2: 'peach' })

#### $size 查询特定长度的数组

> 不能与 $lt、$gt 等查询条件组合使用，可以通过添加 size 字段弥补

    <!-- 返回 fruit 字段的长度为3的文档  -->
    db.food.find({ fruit: { $size: 3 } })

#### $slice 返回某个键匹配的数组的一个子集

> $slice为正数顺序返回，为负数倒序返回

    <!-- 返回前10条评论  -->
    db.blog.posts.findOne([ criteria ], { comments: { $slice: 10 } })
    
    <!-- 返回最后10条评论  -->
    db.blog.posts.findOne([ criteria ], { comments: { $slice: -10 } })

    <!-- 返回最后24-33条评论  -->
    db.blog.posts.findOne([ criteria ], { comments: { $slice: [23, 10] } })

> 默认返回所有键，别的键说明符都是默认不返回未提及的键

    db.blog.posts.findOne([ criteria ], { comments: { $slice: -1 } })
    {
        _id: ...,
        title: ...,
        content: ...,
        comments: [
            { ... },
            { ... },
        ]
    }

#### $ 返回一个匹配的数组元素

> 只会返回第一个匹配的元素

    db.blog.posts.find({ comments.name: 'Bob' }, {
        comments.$: 1
    })
    {
        _id: ...,
        comments: [
            {
                name: 'Bob',
                email: ...,
                content: ...
            }
        ]
    }

#### 数组和范围查询的相互作用

查询条件中的每条语句可以匹配不同的数组元素

    { x: 5 }
    { x: 15 }
    { x: 25 }
    { x: [5, 25] }

    db.test.find({ x: { $gt: 10, $lt: 20 } })
    { x: 5 }
    { x: [5, 25] }

获取预期的值

- $elemMatch 同时使用查询条件中的两个语句与一个数组元素进行比较

  > $elemMatch 不会匹配非数组元素

        <!-- 查不到任何结果  -->
        <!-- { x: 15 } 的 x 字段不是数组  -->
        db.test.find(x: { $elemMatch: { $lt: 10, $gt: 20 } })

- 如果当前查询字段上创建过索引，可以使用 min() 和 max() 将查询条件遍历的索引范围限制为 $gt 和 $lt 的值

        <!-- 仅遍历值位于10 - 20之间的索引，不再与2 和 25比较  -->
        db.test.find({ x: { $gt: 10, $lt: 20 } }).min({ x: 10 }).max({ x: 20 })
        { x: 15 }

### 查询内嵌文档

